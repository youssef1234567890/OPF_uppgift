@page "/chat/Series"

@using BlazorApp.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Web
@attribute [Authorize]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ApplicationDbContext dbContext
@inject UserManager<ApplicationUser> UserManager

<div class="container mt-5">
    <div class="card p-4 shadow-sm">
        <h3 class="text-center mb-4">Series Chat</h3>

        <AuthorizeView>
            <Authorized>
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="newMessageText" @onkeypress="HandleKeyPress" placeholder="Enter message..." />
                        <button class="btn btn-primary" @onclick="SendMessage" disabled="@string.IsNullOrWhiteSpace(newMessageText)">Send</button>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(replyingToMessage))
                {
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <span><strong>Replying to:</strong> @replyingToMessage</span>
                        <button class="btn btn-sm btn-outline-danger" @onclick="CancelReply">Cancel</button>
                    </div>
                }

                <div class="chat-box border rounded p-3" style="max-width: 600px; height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                    @if (messages.Any())
                    {
                        @foreach (var message in messages)
                        {
                            <div class="border-bottom pb-2 mb-2">
                                <strong>@message.UserName</strong>: @message.Text
                                <em class="text-muted" style="font-size: 0.8rem;">(@message.Timestamp.ToLocalTime())</em>

                                @if (!string.IsNullOrEmpty(message.ReplyTo))
                                {
                                    <div class="text-muted" style="margin-left: 20px; font-style: italic; font-size: 0.9rem;">
                                        ↪️ Replying to: @message.ReplyTo
                                    </div>
                                }

                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => SetReplyContext(message.Text)">Reply</button>

                                    @if (message.UserName == currentUser || isAdmin)
                                    {
                                        <button class="btn btn-sm btn-outline-danger ms-2" @onclick="() => DeleteMessage(message.Id)">Delete</button>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted">No messages yet.</div>
                    }
                </div>
            </Authorized>

            <NotAuthorized>
                <p class="text-center text-danger">You must be logged in to access the chat.</p>
            </NotAuthorized>
        </AuthorizeView>
    </div>
</div>

@code {
    private string currentUser = string.Empty;
    private string currentUserId = string.Empty; //  store the user's ID
    private ApplicationUser currentUserEntity = null!; //  store the ApplicationUser entity
    private string newMessageText = string.Empty;
    private string replyingToMessage = string.Empty;
    private List<Message> messages = new();
    private bool isAdmin = false;

    // Initializes the component and loads messages from the database
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity is { IsAuthenticated: true })
        {
            currentUser = user.Identity.Name ?? "Unknown";

            var identityUser = await UserManager.FindByNameAsync(currentUser);
            if (identityUser != null)
            {
                currentUserId = identityUser.Id;
                currentUserEntity = identityUser;
                var roles = await UserManager.GetRolesAsync(identityUser);
                isAdmin = roles.Contains("mainadmin") || roles.Contains("admin");
            }
        }

        messages = await dbContext.Messages
                                  .Where(m => m.ChatRoom == "Series")
                                  .OrderBy(m => m.Timestamp)
                                  .ToListAsync();
    }

    // Sends a new message to the chat
    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(newMessageText))
        {
            var message = new Message
            {
                // Remove assignment to UserName; assign ApplicationUserId and ApplicationUser instead.
                ApplicationUserId = currentUserId,
                ApplicationUser = currentUserEntity,
                Text = newMessageText,
                Timestamp = DateTime.UtcNow,
                ChatRoom = "Series",
                ReplyTo = replyingToMessage
            };

            dbContext.Messages.Add(message);
            await dbContext.SaveChangesAsync();
            messages.Add(message);

            newMessageText = string.Empty;
            replyingToMessage = string.Empty;
            StateHasChanged();
        }
    }

    // Handles the Enter key press to send a message
    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }

    // Deletes a message from the chat
    private async Task DeleteMessage(int messageId)
    {
        var message = await dbContext.Messages.FindAsync(messageId);
        if (message != null && (message.UserName == currentUser || isAdmin))
        {
            dbContext.Messages.Remove(message);
            await dbContext.SaveChangesAsync();
            messages.Remove(message);
            StateHasChanged();
        }
    }

    // Sets the context for replying to a message
    private void SetReplyContext(string originalMessage)
    {
        replyingToMessage = originalMessage;
    }

    // Cancels the reply context
    private void CancelReply()
    {
        replyingToMessage = string.Empty;
    }
}
